name: Yahoo RAW batch

on:
  workflow_dispatch:
    inputs:
      tickers:
        description: "Comma-separated tickers (e.g. AAPL,MSFT,NVDA)"
        required: true
        default: "AAPL,MSFT"
      start:
        description: "Start date (YYYY-MM-DD)"
        required: false
        default: "1996-01-01"
      end:
        description: "End date (optional; blank = today)"
        required: false
        default: ""
      force:
        description: "Ignore Yahoo probe and attempt anyway (yes/no)"
        required: false
        default: "no"

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install yfinance pandas pyarrow requests supabase

      - name: Ingest via Yahoo RAW batch
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          INPUT_TICKERS: ${{ github.event.inputs.tickers }}
          INPUT_START:   ${{ github.event.inputs.start }}
          INPUT_END:     ${{ github.event.inputs.end }}
          INPUT_FORCE:   ${{ github.event.inputs.force }}
        run: |
          python - <<'PY'
          import os, json, sys, requests
          from data_lake.storage import Storage

          # Try to import the helper; handle if not present
          try:
              from data_lake.ingest import ingest_raw_yahoo_batch
          except Exception as e:
              print("Note: ingest_raw_yahoo_batch import failed:", repr(e))
              ingest_raw_yahoo_batch = None

          UA = ("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 "
                "(KHTML, like Gecko) Chrome/124.0 Safari/537.36")

          # Patch requests so every call looks like a real browser
          _orig_request = requests.sessions.Session.request
          def _patched(self, method, url, **kwargs):
              headers = kwargs.get("headers") or {}
              headers.setdefault("User-Agent", UA)
              headers.setdefault("Accept", "application/json,text/plain,*/*")
              headers.setdefault("Accept-Language", "en-US,en;q=0.9")
              kwargs["headers"] = headers
              kwargs.setdefault("timeout", 20)
              return _orig_request(self, method, url, **kwargs)
          requests.sessions.Session.request = _patched

          def probe_yahoo():
              """Return (ok, note). Try multiple lightweight endpoints."""
              urls = [
                  "https://query2.finance.yahoo.com/v8/finance/chart/AAPL?range=1d&interval=1d",
                  "https://query1.finance.yahoo.com/v7/finance/quote?symbols=AAPL",
              ]
              last = "no-attempt"
              s = requests.Session()
              for u in urls:
                  try:
                      r = s.get(u, allow_redirects=True, timeout=12)
                      last = f"{u} status={r.status_code}"
                      if r.status_code == 200 and "{" in r.text:
                          return True, last
                  except Exception as e:
                      last = f"{u} exc={repr(e)}"
              return False, last

          ok_probe, info = probe_yahoo()
          print("Yahoo probe:", ok_probe, info)

          force = (os.environ.get("INPUT_FORCE","no").strip().lower() in ("yes","true","1","y"))

          raw = (os.environ.get("INPUT_TICKERS") or "AAPL,MSFT").strip()
          start = (os.environ.get("INPUT_START") or "1996-01-01").strip()
          end = (os.environ.get("INPUT_END") or "").strip() or None
          tickers = [t.strip().upper() for t in raw.split(",") if t.strip()]
          jobs = [{"ticker": t, "start": start, "end": end} for t in tickers]
          print("Jobs:", jobs)

          if not ok_probe and not force:
              print("Yahoo seems blocked right now. Skipping ingest (set Force=yes to try anyway).")
              sys.exit(0)

          s = Storage.from_env()
          print("Storage:", s.diagnostics())

          summary = {"ok": 0, "failed": 0, "results": []}
          try:
              if ingest_raw_yahoo_batch is None:
                  raise RuntimeError("ingest_raw_yahoo_batch not available in this build")
              summary = ingest_raw_yahoo_batch(s, jobs)
          except Exception as e:
              print("ingest_raw_yahoo_batch raised:", repr(e))
              summary = {
                  "ok": 0,
                  "failed": len(jobs),
                  "results": [{"ticker": j["ticker"], "error": str(e)} for j in jobs],
              }

          print("Summary:", json.dumps(summary, indent=2))
          if int(summary.get("ok", 0)) == 0:
              sys.exit(1)
          PY
