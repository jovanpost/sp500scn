name: Yahoo RAW batch ingest

on:
  workflow_dispatch:
    inputs:
      tickers:
        description: "Comma-separated tickers (e.g. AAPL,MSFT,NVDA)"
        required: true
        default: "AAPL,MSFT"
      start:
        description: "Start date (YYYY-MM-DD)"
        required: false
        default: "1996-01-01"
      end:
        description: "End date (optional; blank means up to today)"
        required: false
        default: ""

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install yfinance pandas pyarrow requests

      - name: Ingest via Yahoo RAW batch
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<'PY'
          import json
          from data_lake.storage import Storage
          from data_lake.ingest import ingest_raw_yahoo_batch

          raw = "${{ github.event.inputs.tickers }}"
          start = "${{ github.event.inputs.start }}".strip() or "1996-01-01"
          end = "${{ github.event.inputs.end }}".strip() or None

          tickers = [t.strip().upper() for t in raw.split(",") if t.strip()]
          jobs = [{"ticker": t, "start": start, "end": end} for t in tickers]

          print("Jobs:", jobs)

          s = Storage.from_env()
          summary = ingest_raw_yahoo_batch(s, jobs)
          print(json.dumps(summary, indent=2))

          # Fail only if everything failed
          if summary.get("ok", 0) == 0:
              raise SystemExit("All jobs failed")
          PY